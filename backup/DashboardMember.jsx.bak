import React, { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';

const DashboardMember = () => {
  const navigate = useNavigate();

  // Add authentication check
  useEffect(() => {
    const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
    if (!isLoggedIn) {
      alert('Please log in to access the member dashboard.');
      navigate('/login');
    }
  }, [navigate]);

  const [smokeFreeCount, setSmokeFreeCount] = useState(() => {
    const savedCount = localStorage.getItem('smokeFreeCount');
    return savedCount ? parseInt(savedCount, 10) : 0;
  });

  const [startDate, setStartDate] = useState(() => {
    const savedDate = localStorage.getItem('smokeFreeStartDate');
    return savedDate ? new Date(savedDate) : new Date();
  });

  const [cigarettesPerDay, setCigarettesPerDay] = useState(() => {
    const saved = localStorage.getItem('cigarettesPerDay');
    return saved ? parseInt(saved, 10) : 1;
  });

  const [pricePerPack, setPricePerPack] = useState(() => {
    const saved = localStorage.getItem('pricePerPack');
    return saved ? parseInt(saved, 10) : 35000;
  });

  const [cigarettesPerPack, setCigarettesPerPack] = useState(() => {
    const saved = localStorage.getItem('cigarettesPerPack');
    return saved ? parseInt(saved, 10) : 20;
  });

  const [quitChoice, setQuitChoice] = useState(() => {
    const saved = localStorage.getItem('quitChoice');
    return saved || 'not_selected';
  });

  const [customDate, setCustomDate] = useState(() => {
    const saved = localStorage.getItem('customQuitDate');
    return saved || new Date().toISOString().split('T')[0];
  });

  const [hasPlan, setHasPlan] = useState(() => {
    return localStorage.getItem('quitChoice') !== null;
  });

  const [moneySaved, setMoneySaved] = useState(() => {
    // Calculate money saved based on days, cigarettes and price
    const cigaretteCost = pricePerPack / cigarettesPerPack;
    const savedMoney = smokeFreeCount * cigarettesPerDay * cigaretteCost;
    return Math.round(savedMoney);
  });

  // New state variables for advanced quit plan
  const [quitReasons, setQuitReasons] = useState(() => {
    const saved = localStorage.getItem('quitReasons');
    return saved ? JSON.parse(saved) : [];
  });

  const [customReason, setCustomReason] = useState('');

  const [expectedQuitDate, setExpectedQuitDate] = useState(() => {
    const saved = localStorage.getItem('expectedQuitDate');
    return saved || new Date(new Date().setDate(new Date().getDate() + 30)).toISOString().split('T')[0];
  });

  const [quitStages, setQuitStages] = useState(() => {
    const saved = localStorage.getItem('quitStages');
    return saved ? JSON.parse(saved) : [];
  });

  const [showAdvancedPlan, setShowAdvancedPlan] = useState(() => {
    return localStorage.getItem('showAdvancedPlan') === 'true';
  });

  const [generatedPlan, setGeneratedPlan] = useState(() => {
    const saved = localStorage.getItem('generatedPlan');
    return saved ? JSON.parse(saved) : null;
  });

  const [yearsSmoked, setYearsSmoked] = useState(() => {
    const saved = localStorage.getItem('yearsSmoked');
    return saved ? parseInt(saved, 10) : 1;
  });

  const [showGeneratePlan, setShowGeneratePlan] = useState(false);

  useEffect(() => {
    localStorage.setItem('smokeFreeCount', smokeFreeCount);
    localStorage.setItem('smokeFreeStartDate', startDate.toISOString());
    localStorage.setItem('cigarettesPerDay', cigarettesPerDay);
    localStorage.setItem('pricePerPack', pricePerPack);
    localStorage.setItem('cigarettesPerPack', cigarettesPerPack);
    localStorage.setItem('quitChoice', quitChoice);
    localStorage.setItem('customQuitDate', customDate);
    localStorage.setItem('quitReasons', JSON.stringify(quitReasons));
    localStorage.setItem('expectedQuitDate', expectedQuitDate);
    localStorage.setItem('quitStages', JSON.stringify(quitStages));
    localStorage.setItem('showAdvancedPlan', showAdvancedPlan.toString());
    localStorage.setItem('generatedPlan', JSON.stringify(generatedPlan));
    localStorage.setItem('yearsSmoked', yearsSmoked);
  }, [
    smokeFreeCount,
    startDate,
    cigarettesPerDay,
    pricePerPack,
    cigarettesPerPack,
    quitChoice,
    customDate,
    quitReasons,
    expectedQuitDate,
    quitStages,
    showAdvancedPlan,
    generatedPlan,
    yearsSmoked
  ]);

  const handleQuitChoiceSelect = (choice) => {
    setQuitChoice(choice);

    if (choice === 'today') {
      setStartDate(new Date());
    } else if (choice === 'tomorrow') {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      setStartDate(tomorrow);
    } else if (choice === 'custom') {
      const customDateObj = new Date(customDate);
      setStartDate(customDateObj);
    }
  };

  const handleSubmitPlan = () => {
    setHasPlan(true);

    // If today, start counting immediately
    if (quitChoice === 'today') {
      setSmokeFreeCount(1);
    } else {
      setSmokeFreeCount(0);
    }

    // Recalculate money saved
    const cigaretteCost = pricePerPack / cigarettesPerPack;
    const savedMoney = smokeFreeCount * cigarettesPerDay * cigaretteCost;
    setMoneySaved(Math.round(savedMoney));
  };

  const increaseSmokeFreeDay = () => {
    setSmokeFreeCount(prev => prev + 1);

    // Recalculate money saved
    const cigaretteCost = pricePerPack / cigarettesPerPack;
    const newCount = smokeFreeCount + 1;
    const savedMoney = newCount * cigarettesPerDay * cigaretteCost;
    setMoneySaved(Math.round(savedMoney));
  };

  const resetSmokeFreeCount = () => {
    if (window.confirm('Are you sure you want to reset your smoke-free days count?')) {
      setSmokeFreeCount(0);
      setStartDate(new Date());
      setMoneySaved(0);
      setHasPlan(false);
      setQuitChoice('not_selected');
    }
  };

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'VND' }).format(amount);
  };

  const resetPlan = () => {
    if (window.confirm('Are you sure you want to create a new plan?')) {
      setHasPlan(false);
      setQuitChoice('not_selected');
      setShowAdvancedPlan(false);
      setGeneratedPlan(null);
    }
  };

  // Add new handler functions for advanced quit plan
  const toggleAdvancedPlan = () => {
    setShowAdvancedPlan(!showAdvancedPlan);
  };

  const handleAddReason = () => {
    if (customReason.trim()) {
      setQuitReasons([...quitReasons, customReason.trim()]);
      setCustomReason('');
    }
  };

  const handleRemoveReason = (index) => {
    const updatedReasons = [...quitReasons];
    updatedReasons.splice(index, 1);
    setQuitReasons(updatedReasons);
  };

  const handleCommonReason = (reason) => {
    if (!quitReasons.includes(reason)) {
      setQuitReasons([...quitReasons, reason]);
    }
  };

  const generateQuitPlan = () => {
    // Calculate stages based on current smoking habits and years smoked
    const startDateObj = new Date();
    const expectedDateObj = new Date(expectedQuitDate);
    const daysDifference = Math.round((expectedDateObj - startDateObj) / (1000 * 60 * 60 * 24));

    // Generate a quit plan based on user data
    const generatedStages = [];

    // Preparation stage
    generatedStages.push({
      name: "Chu·∫©n b·ªã",
      startDate: new Date().toISOString().split('T')[0],
      endDate: new Date(new Date().setDate(new Date().getDate() + Math.round(daysDifference * 0.2))).toISOString().split('T')[0],
      goal: "H·ªçc v·ªÅ cƒÉng th·∫≥ng v√† chu·∫©n b·ªã tinh th·∫ßn",
      tasks: [
        "Danh s√°ch l√Ω do t·ª´ b·∫°n",
        "Nh·∫≠n di·ªán k√≠ch th√≠ch h√∫t thu·ªëc",
        "N√≥i chuy·ªán v·ªõi b·∫°n b√® v√† gia ƒë√¨nh v·ªÅ k·∫ø ho·∫°ch",
        "ƒê·∫∑t l·ªãch h·∫πn v·ªõi b√°c sƒ©"
      ]
    });

    // Reduction stage - based on cigarettes per day
    const reductionDays = Math.round(daysDifference * 0.5);
    const reductionStart = new Date(new Date().setDate(new Date().getDate() + Math.round(daysDifference * 0.2) + 1));
    const reductionEnd = new Date(new Date().setDate(new Date().getDate() + Math.round(daysDifference * 0.7)));

    generatedStages.push({
      name: "Gi·∫£m d·∫ßn",
      startDate: reductionStart.toISOString().split('T')[0],
      endDate: reductionEnd.toISOString().split('T')[0],
      goal: `Gi·∫£m d·∫ßn h√∫t thu·ªëc t·ª´ ${cigarettesPerDay} ƒë·∫øn ${Math.ceil(cigarettesPerDay / 2)} ƒëi·∫øu thu·ªëc m·ªói ng√†y`,
      tasks: [
        "Tr√¨ ho√£n h√∫t thu·ªëc s√°ng 1 gi·ªù",
        "Ch·ªâ h√∫t n·ª≠a ƒëi·∫øu thu·ªëc",
        "B·ªè qua m·ªôt kho·∫£ng ngh·ªâ h√∫t thu·ªëc m·ªói ng√†y",
        "Chuy·ªÉn sang th∆∞∆°ng hi·ªáu k√©m h·∫•p d·∫´n h∆°n"
      ]
    });

    // Quit day preparation
    const quitPrepStart = new Date(new Date().setDate(new Date().getDate() + Math.round(daysDifference * 0.7) + 1));
    const quitPrepEnd = new Date(new Date().setDate(new Date().getDate() + daysDifference - 1));

    generatedStages.push({
      name: "Chu·∫©n b·ªã cho ng√†y cai thu·ªëc",
      startDate: quitPrepStart.toISOString().split('T')[0],
      endDate: quitPrepEnd.toISOString().split('T')[0],
      goal: "Chu·∫©n b·ªã ho√†n to√†n cho cai thu·ªëc",
      tasks: [
        "Lo·∫°i b·ªè t·∫•t c·∫£ d·ª•ng c·ª• h√∫t thu·ªëc",
        "L√†m s·∫°ch nh√† v√† xe h∆°i ƒë·ªÉ lo·∫°i b·ªè m√πi thu·ªëc",
        "Th·ª±c h√†nh c√°c k·ªπ thu·∫≠t gi·∫£m cƒÉng th·∫≥ng",
        "T·ªìn kho th·ª±c ph·∫©m v√† n∆∞·ªõc kho√°ng"
      ]
    });

    // Quit day
    generatedStages.push({
      name: "Ng√†y cai thu·ªëc",
      startDate: expectedQuitDate,
      endDate: expectedQuitDate,
      goal: "Ng·ª´ng h√∫t thu·ªëc ho√†n to√†n",
      tasks: [
        "Th·ª©c d·∫≠y nh∆∞ kh√¥ng h√∫t thu·ªëc",
        "B·∫≠n r·ªôn su·ªët ng√†y",
        "U·ªëng ƒë·ªß n∆∞·ªõc",
        "G·ªçi b·∫°n b√® ƒë·ªÉ h·ªó tr·ª£"
      ]
    });

    // Recovery stages
    generatedStages.push({
      name: "T√¨nh tr·∫°ng h·ªìi ph·ª•c s·ªõm",
      startDate: new Date(new Date(expectedQuitDate).setDate(new Date(expectedQuitDate).getDate() + 1)).toISOString().split('T')[0],
      endDate: new Date(new Date(expectedQuitDate).setDate(new Date(expectedQuitDate).getDate() + 14)).toISOString().split('T')[0],
      goal: "ƒêi·ªÅu h∆∞·ªõng qua c√°c tri·ªáu ch·ª©ng r√∫t thu·ªëc",
      tasks: [
        "ƒêi m·ªôt ng√†y t·∫°i m·ªôt th·ªùi ƒëi·ªÉm",
        "S·ª≠ d·ª•ng th·ªü d·ª•c khi c·∫£m th·∫•y c·∫ßn h√∫t thu·ªëc",
        "T·∫≠p th·ªÉ d·ª•c h√†ng ng√†y",
        "T·ª± h√†o v·ªÅ nh·ªØng th√†nh t√≠ch nh·ªè"
      ]
    });

    setGeneratedPlan({
      stages: generatedStages,
      cigarettesPerDay,
      yearsSmoked,
      expectedQuitDate
    });

    setQuitStages(generatedStages);
    setShowGeneratePlan(false);
  };

  const handleStageChange = (index, field, value) => {
    const updatedStages = [...quitStages];
    updatedStages[index][field] = value;
    setQuitStages(updatedStages);
  };

  const handleTaskChange = (stageIndex, taskIndex, value) => {
    const updatedStages = [...quitStages];
    updatedStages[stageIndex].tasks[taskIndex] = value;
    setQuitStages(updatedStages);
  };

  const addTask = (stageIndex) => {
    const updatedStages = [...quitStages];
    updatedStages[stageIndex].tasks.push("New task");
    setQuitStages(updatedStages);
  };

  const removeTask = (stageIndex, taskIndex) => {
    const updatedStages = [...quitStages];
    updatedStages[stageIndex].tasks.splice(taskIndex, 1);
    setQuitStages(updatedStages);
  };

  const addStage = () => {
    const lastStage = quitStages[quitStages.length - 1];
    const newStartDate = lastStage ?
      new Date(new Date(lastStage.endDate).setDate(new Date(lastStage.endDate).getDate() + 1)).toISOString().split('T')[0] :
      new Date().toISOString().split('T')[0];

    const newEndDate = new Date(new Date(newStartDate).setDate(new Date(newStartDate).getDate() + 7)).toISOString().split('T')[0];

    setQuitStages([...quitStages, {
      name: "New Stage",
      startDate: newStartDate,
      endDate: newEndDate,
      goal: "Set your goal",
      tasks: ["Add tasks here"]
    }]);
  };

  const removeStage = (index) => {
    const updatedStages = [...quitStages];
    updatedStages.splice(index, 1);
    setQuitStages(updatedStages);
  };

  return (
    <div style={{
      minHeight: '100vh',
      width: '100%',
      background: 'linear-gradient(135deg, #f0f7fa 0%, #d5f1e8 100%)',
      fontFamily: '"Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif',
      padding: '2rem',
      boxSizing: 'border-box',
      overflowX: 'hidden'
    }}>
      <div style={{
        maxWidth: '100%',
        margin: '0 auto',
        width: '100%',
        boxSizing: 'border-box'
      }}>
        <div style={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '2rem',
          flexWrap: 'wrap',
          gap: '1rem'
        }}>
          <h1 style={{
            fontSize: '2.2rem',
            fontWeight: '700',
            color: '#2c3e50',
            margin: 0
          }}>B·∫£ng ƒêi·ªÅu Khi·ªÉn Th√†nh Vi√™n</h1>
          <div style={{
            display: 'flex',
            gap: '1rem'
          }}>
            <Link to="/homepage-member" style={{
              padding: '0.5rem 1.5rem',
              backgroundColor: '#35a79c',
              color: 'white',
              textDecoration: 'none',
              borderRadius: '50px',
              fontWeight: '500',
              boxShadow: '0 4px 6px rgba(53, 167, 156, 0.2)'
            }}>Quay L·∫°i Trang Ch·ªß</Link>
          </div>
        </div>

        <div style={{
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))',
          gap: '2rem',
          width: '100%'
        }}>
          <div style={{
            padding: '2rem',
            backgroundColor: 'white',
            borderRadius: '15px',
            boxShadow: '0 5px 15px rgba(0, 0, 0, 0.05)'
          }}>
            <h2 style={{ fontWeight: '600', marginBottom: '1rem', color: '#35a79c' }}>K·∫ø Ho·∫°ch Cai Thu·ªëc</h2>

            {!hasPlan ? (
              <div style={{ color: '#7f8c8d', lineHeight: '1.6' }}>
                <div style={{ marginBottom: '1.5rem' }}>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>
                    Khi n√†o b·∫°n s·∫Ω b·∫Øt ƒë·∫ßu cai thu·ªëc?
                  </label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    <div>
                      <input
                        type="radio"
                        id="today"
                        name="quitDay"
                        value="today"
                        checked={quitChoice === 'today'}
                        onChange={() => handleQuitChoiceSelect('today')}
                      />
                      <label htmlFor="today" style={{ marginLeft: '0.5rem' }}>H√¥m nay</label>
                    </div>
                    <div>
                      <input
                        type="radio"
                        id="tomorrow"
                        name="quitDay"
                        value="tomorrow"
                        checked={quitChoice === 'tomorrow'}
                        onChange={() => handleQuitChoiceSelect('tomorrow')}
                      />
                      <label htmlFor="tomorrow" style={{ marginLeft: '0.5rem' }}>Ng√†y mai</label>
                    </div>
                    <div>
                      <input
                        type="radio"
                        id="custom"
                        name="quitDay"
                        value="custom"
                        checked={quitChoice === 'custom'}
                        onChange={() => handleQuitChoiceSelect('custom')}
                      />
                      <label htmlFor="custom" style={{ marginLeft: '0.5rem' }}>Ch·ªçn ng√†y</label>
                      {quitChoice === 'custom' && (
                        <input
                          type="date"
                          value={customDate}
                          onChange={(e) => setCustomDate(e.target.value)}
                          style={{
                            display: 'block',
                            marginTop: '0.5rem',
                            padding: '0.5rem',
                            borderRadius: '5px',
                            border: '1px solid #ddd'
                          }}
                        />
                      )}
                    </div>
                    <div>
                      <input
                        type="radio"
                        id="not_ready"
                        name="quitDay"
                        value="not_ready"
                        checked={quitChoice === 'not_ready'}
                        onChange={() => handleQuitChoiceSelect('not_ready')}
                      />
                      <label htmlFor="not_ready" style={{ marginLeft: '0.5rem' }}>Ch∆∞a s·∫µn s√†ng</label>
                    </div>
                  </div>
                </div>

                <div style={{ marginTop: '1.5rem' }}>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>
                    S·ªë ƒëi·∫øu thu·ªëc h√∫t m·ªói ng√†y:
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={cigarettesPerDay}
                    onChange={(e) => setCigarettesPerDay(parseInt(e.target.value))}
                    style={{
                      padding: '0.5rem',
                      borderRadius: '5px',
                      border: '1px solid #ddd',
                      width: '100%',
                      marginBottom: '1rem'
                    }}
                  />

                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>
                    S·ªë ƒëi·∫øu thu·ªëc trong m·ªôt g√≥i:
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={cigarettesPerPack}
                    onChange={(e) => setCigarettesPerPack(parseInt(e.target.value))}
                    style={{
                      padding: '0.5rem',
                      borderRadius: '5px',
                      border: '1px solid #ddd',
                      width: '100%',
                      marginBottom: '1rem'
                    }}
                  />

                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>
                    Gi√° m·ªôt g√≥i thu·ªëc (VND):
                  </label>
                  <input
                    type="number"
                    min="1000"
                    step="1000"
                    value={pricePerPack}
                    onChange={(e) => setPricePerPack(parseInt(e.target.value))}
                    style={{
                      padding: '0.5rem',
                      borderRadius: '5px',
                      border: '1px solid #ddd',
                      width: '100%',
                      marginBottom: '1rem'
                    }}
                  />

                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600' }}>
                    S·ªë nƒÉm b·∫°n ƒë√£ h√∫t thu·ªëc:
                  </label>
                  <input
                    type="number"
                    min="1"
                    value={yearsSmoked}
                    onChange={(e) => setYearsSmoked(parseInt(e.target.value))}
                    style={{
                      padding: '0.5rem',
                      borderRadius: '5px',
                      border: '1px solid #ddd',
                      width: '100%',
                      marginBottom: '1rem'
                    }}
                  />
                </div>

                <div style={{ marginTop: '1.5rem' }}>
                  <button
                    onClick={toggleAdvancedPlan}
                    style={{
                      padding: '0.7rem 1.2rem',
                      backgroundColor: '#3498db',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      fontWeight: '500',
                      boxShadow: '0 2px 4px rgba(52, 152, 219, 0.3)',
                      width: '100%',
                      marginBottom: '1rem'
                    }}
                  >
                    {showAdvancedPlan ? '·∫®n T√πy Ch·ªçn N√¢ng Cao' : 'Hi·ªÉn Th·ªã T√πy Ch·ªçn N√¢ng Cao'}
                  </button>

                  {showAdvancedPlan && (
                    <div style={{
                      border: '1px solid #e0e0e0',
                      borderRadius: '8px',
                      padding: '1rem',
                      marginBottom: '1rem'
                    }}>
                      <h3 style={{ fontWeight: '600', marginBottom: '1rem', color: '#3498db' }}>
                        L√Ω Do Cai Thu·ªëc C·ªßa T√¥i
                      </h3>

                      <div style={{ marginBottom: '1rem' }}>
                        <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.5rem', flexWrap: 'wrap' }}>
                          <button
                            onClick={() => handleCommonReason('C·∫£i thi·ªán s·ª©c kh·ªèe')}
                            style={{
                              padding: '0.5rem 0.8rem',
                              background: '#e0f7fa',
                              border: '1px solid #80deea',
                              borderRadius: '50px',
                              fontSize: '0.9rem',
                              cursor: 'pointer'
                            }}
                          >
                            S·ª©c Kh·ªèe
                          </button>
                          <button
                            onClick={() => handleCommonReason('Ti·∫øt ki·ªám ti·ªÅn')}
                            style={{
                              padding: '0.5rem 0.8rem',
                              background: '#e0f7fa',
                              border: '1px solid #80deea',
                              borderRadius: '50px',
                              fontSize: '0.9rem',
                              cursor: 'pointer'
                            }}
                          >
                            Ti·ªÅn B·∫°c
                          </button>
                          <button
                            onClick={() => handleCommonReason('Gia ƒë√¨nh v√† m·ªëi quan h·ªá')}
                            style={{
                              padding: '0.5rem 0.8rem',
                              background: '#e0f7fa',
                              border: '1px solid #80deea',
                              borderRadius: '50px',
                              fontSize: '0.9rem',
                              cursor: 'pointer'
                            }}
                          >
                            Gia ƒê√¨nh
                          </button>
                          <button
                            onClick={() => handleCommonReason('TƒÉng nƒÉng l∆∞·ª£ng v√† s·ª©c kh·ªèe')}
                            style={{
                              padding: '0.5rem 0.8rem',
                              background: '#e0f7fa',
                              border: '1px solid #80deea',
                              borderRadius: '50px',
                              fontSize: '0.9rem',
                              cursor: 'pointer'
                            }}
                          >
                            NƒÉng L∆∞·ª£ng
                          </button>
                          <button
                            onClick={() => handleCommonReason('Tho√°t kh·ªèi s·ª± ph·ª• thu·ªôc')}
                            style={{
                              padding: '0.5rem 0.8rem',
                              background: '#e0f7fa',
                              border: '1px solid #80deea',
                              borderRadius: '50px',
                              fontSize: '0.9rem',
                              cursor: 'pointer'
                            }}
                          >
                            T·ª± Do
                          </button>
                        </div>

                        <div style={{ display: 'flex', marginBottom: '0.5rem' }}>
                          <input
                            type="text"
                            value={customReason}
                            onChange={(e) => setCustomReason(e.target.value)}
                            placeholder="Th√™m l√Ω do c·ªßa ri√™ng b·∫°n..."
                            style={{
                              padding: '0.5rem',
                              borderRadius: '5px 0 0 5px',
                              border: '1px solid #ddd',
                              borderRight: 'none',
                              flexGrow: 1
                            }}
                          />
                          <button
                            onClick={handleAddReason}
                            style={{
                              padding: '0.5rem 1rem',
                              backgroundColor: '#27ae60',
                              color: 'white',
                              border: 'none',
                              borderRadius: '0 5px 5px 0',
                              cursor: 'pointer'
                            }}
                          >
                            Th√™m
                          </button>
                        </div>

                        {quitReasons.length > 0 ? (
                          <ul style={{
                            listStyleType: 'none',
                            padding: '0.5rem',
                            background: '#f9f9f9',
                            borderRadius: '5px',
                            maxHeight: '150px',
                            overflowY: 'auto'
                          }}>
                            {quitReasons.map((reason, index) => (
                              <li key={index} style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                padding: '0.5rem',
                                borderBottom: index < quitReasons.length - 1 ? '1px solid #eee' : 'none'
                              }}>
                                <span>{reason}</span>
                                <button
                                  onClick={() => handleRemoveReason(index)}
                                  style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#e74c3c',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                  }}
                                >
                                  √ó
                                </button>
                              </li>
                            ))}
                          </ul>
                        ) : (
                          <p style={{ color: '#95a5a6', padding: '0.5rem 0' }}>Th√™m l√Ω do cai thu·ªëc c·ªßa b·∫°n</p>
                        )}
                      </div>

                      <h3 style={{ fontWeight: '600', marginBottom: '1rem', color: '#3498db' }}>
                        Ng√†y D·ª± Ki·∫øn Cai Thu·ªëc
                      </h3>

                      <div style={{ marginBottom: '1rem' }}>
                        <input
                          type="date"
                          value={expectedQuitDate}
                          onChange={(e) => setExpectedQuitDate(e.target.value)}
                          style={{
                            padding: '0.5rem',
                            borderRadius: '5px',
                            border: '1px solid #ddd',
                            width: '100%'
                          }}
                        />
                      </div>

                      <button
                        onClick={() => setShowGeneratePlan(true)}
                        style={{
                          padding: '0.7rem 1.2rem',
                          backgroundColor: '#9b59b6',
                          color: 'white',
                          border: 'none',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          fontWeight: '500',
                          boxShadow: '0 2px 4px rgba(155, 89, 182, 0.3)',
                          width: '100%'
                        }}
                      >
                        T·∫°o K·∫ø Ho·∫°ch Cai Thu·ªëc
                      </button>

                      {showGeneratePlan && (
                        <div style={{
                          marginTop: '1rem',
                          padding: '1rem',
                          background: '#f5f5f5',
                          borderRadius: '8px'
                        }}>
                          <p>D·ª±a tr√™n th√≥i quen h√∫t thu·ªëc c·ªßa b·∫°n, ch√∫ng t√¥i s·∫Ω t·∫°o k·∫ø ho·∫°ch cai thu·ªëc c√° nh√¢n h√≥a bao g·ªìm:</p>
                          <ul style={{ paddingLeft: '1.5rem', marginTop: '0.5rem' }}>
                            <li>Giai ƒëo·∫°n chu·∫©n b·ªã</li>
                            <li>C√°c b∆∞·ªõc gi·∫£m d·∫ßn</li>
                            <li>Chu·∫©n b·ªã cho ng√†y cai thu·ªëc</li>
                            <li>H·ªó tr·ª£ ph·ª•c h·ªìi</li>
                          </ul>

                          <div style={{
                            display: 'flex',
                            gap: '0.5rem',
                            marginTop: '1rem',
                            justifyContent: 'space-between'
                          }}>
                            <button
                              onClick={() => setShowGeneratePlan(false)}
                              style={{
                                padding: '0.5rem 1rem',
                                backgroundColor: '#7f8c8d',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontWeight: '500',
                                flexGrow: 1
                              }}
                            >
                              H·ªßy
                            </button>
                            <button
                              onClick={generateQuitPlan}
                              style={{
                                padding: '0.5rem 1rem',
                                backgroundColor: '#2ecc71',
                                color: 'white',
                                border: 'none',
                                borderRadius: '8px',
                                cursor: 'pointer',
                                fontWeight: '500',
                                flexGrow: 1
                              }}
                            >
                              T·∫°o K·∫ø Ho·∫°ch
                            </button>
                          </div>
                        </div>
                      )}

                      {quitStages.length > 0 && (
                        <div style={{ marginTop: '1.5rem' }}>
                          <h3 style={{ fontWeight: '600', marginBottom: '1rem', color: '#3498db' }}>
                            H√†nh Tr√¨nh Cai Thu·ªëc C·ªßa B·∫°n
                          </h3>

                          {quitStages.map((stage, stageIndex) => (
                            <div key={stageIndex} style={{
                              border: '1px solid #ddd',
                              borderRadius: '8px',
                              padding: '1rem',
                              marginBottom: '1rem'
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <input
                                  type="text"
                                  value={stage.name}
                                  onChange={(e) => handleStageChange(stageIndex, 'name', e.target.value)}
                                  style={{
                                    padding: '0.5rem',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd',
                                    fontWeight: 'bold',
                                    width: '60%'
                                  }}
                                />
                                <button
                                  onClick={() => removeStage(stageIndex)}
                                  style={{
                                    background: 'none',
                                    border: 'none',
                                    color: '#e74c3c',
                                    cursor: 'pointer',
                                    fontWeight: 'bold'
                                  }}
                                >
                                  X√≥a
                                </button>
                              </div>

                              <div style={{
                                display: 'flex',
                                gap: '0.5rem',
                                marginTop: '0.5rem',
                                flexWrap: 'wrap'
                              }}>
                                <div style={{ flexGrow: 1, minWidth: '120px' }}>
                                  <label style={{
                                    display: 'block',
                                    marginBottom: '0.3rem',
                                    fontSize: '0.9rem',
                                    color: '#7f8c8d'
                                  }}>
                                    Ng√†y B·∫Øt ƒê·∫ßu:
                                  </label>
                                  <input
                                    type="date"
                                    value={stage.startDate}
                                    onChange={(e) => handleStageChange(stageIndex, 'startDate', e.target.value)}
                                    style={{
                                      padding: '0.5rem',
                                      borderRadius: '5px',
                                      border: '1px solid #ddd',
                                      width: '100%'
                                    }}
                                  />
                                </div>
                                <div style={{ flexGrow: 1, minWidth: '120px' }}>
                                  <label style={{
                                    display: 'block',
                                    marginBottom: '0.3rem',
                                    fontSize: '0.9rem',
                                    color: '#7f8c8d'
                                  }}>
                                    Ng√†y K·∫øt Th√∫c:
                                  </label>
                                  <input
                                    type="date"
                                    value={stage.endDate}
                                    onChange={(e) => handleStageChange(stageIndex, 'endDate', e.target.value)}
                                    style={{
                                      padding: '0.5rem',
                                      borderRadius: '5px',
                                      border: '1px solid #ddd',
                                      width: '100%'
                                    }}
                                  />
                                </div>
                              </div>

                              <div style={{ marginTop: '0.5rem' }}>
                                <label style={{
                                  display: 'block',
                                  marginBottom: '0.3rem',
                                  fontSize: '0.9rem',
                                  color: '#7f8c8d'
                                }}>
                                  M·ª•c Ti√™u:
                                </label>
                                <input
                                  type="text"
                                  value={stage.goal}
                                  onChange={(e) => handleStageChange(stageIndex, 'goal', e.target.value)}
                                  style={{
                                    padding: '0.5rem',
                                    borderRadius: '5px',
                                    border: '1px solid #ddd',
                                    width: '100%'
                                  }}
                                />
                              </div>

                              <div style={{ marginTop: '0.5rem' }}>
                                <label style={{
                                  marginBottom: '0.3rem',
                                  fontSize: '0.9rem',
                                  color: '#7f8c8d',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center'
                                }}>
                                  <span>Nhi·ªám V·ª•:</span>
                                  <button
                                    onClick={() => addTask(stageIndex)}
                                    style={{
                                      fontSize: '0.8rem',
                                      padding: '0.2rem 0.5rem',
                                      background: '#3498db',
                                      color: 'white',
                                      border: 'none',
                                      borderRadius: '4px',
                                      cursor: 'pointer'
                                    }}
                                  >
                                    Th√™m Nhi·ªám V·ª•
                                  </button>
                                </label>
                                <ul style={{
                                  listStyleType: 'none',
                                  padding: '0.5rem',
                                  background: '#f9f9f9',
                                  borderRadius: '5px',
                                  margin: 0
                                }}>
                                  {stage.tasks.map((task, taskIndex) => (
                                    <li key={taskIndex} style={{
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      padding: '0.5rem',
                                      borderBottom: taskIndex < stage.tasks.length - 1 ? '1px solid #eee' : 'none'
                                    }}>
                                      <input
                                        type="text"
                                        value={task}
                                        onChange={(e) => handleTaskChange(stageIndex, taskIndex, e.target.value)}
                                        style={{
                                          padding: '0.3rem',
                                          borderRadius: '5px',
                                          border: '1px solid #ddd',
                                          flexGrow: 1
                                        }}
                                      />
                                      <button
                                        onClick={() => removeTask(stageIndex, taskIndex)}
                                        style={{
                                          background: 'none',
                                          border: 'none',
                                          color: '#e74c3c',
                                          cursor: 'pointer',
                                          fontWeight: 'bold',
                                          marginLeft: '0.5rem'
                                        }}
                                      >
                                        √ó
                                      </button>
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            </div>
                          ))}

                          <button
                            onClick={addStage}
                            style={{
                              padding: '0.7rem 1.2rem',
                              backgroundColor: '#f39c12',
                              color: 'white',
                              border: 'none',
                              borderRadius: '8px',
                              cursor: 'pointer',
                              fontWeight: '500',
                              boxShadow: '0 2px 4px rgba(243, 156, 18, 0.3)',
                              width: '100%'
                            }}
                          >
                            Th√™m Giai ƒêo·∫°n M·ªõi
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <button
                  onClick={handleSubmitPlan}
                  disabled={quitChoice === 'not_selected'}
                  style={{
                    padding: '0.7rem 1.2rem',
                    backgroundColor: quitChoice === 'not_selected' ? '#95a5a6' : '#2ecc71',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: quitChoice === 'not_selected' ? 'not-allowed' : 'pointer',
                    fontWeight: '500',
                    boxShadow: '0 2px 4px rgba(46, 204, 113, 0.3)',
                    width: '100%',
                    marginTop: '1rem'
                  }}
                >
                  T·∫°o K·∫ø Ho·∫°ch
                </button>
              </div>
            ) : (
              <div style={{ color: '#7f8c8d', lineHeight: '1.6' }}>
                <p>
                  <strong>Ng√†y b·∫Øt ƒë·∫ßu:</strong> {startDate.toLocaleDateString('en-US')}
                </p>
                <p>
                  <strong>S·ªë ƒëi·∫øu thu·ªëc m·ªói ng√†y:</strong> {cigarettesPerDay}
                </p>
                <p>
                  <strong>Gi√° m·ªôt g√≥i thu·ªëc:</strong> {formatCurrency(pricePerPack)}
                </p>
                <p>
                  <strong>Chi ph√≠ h√†ng ng√†y:</strong> {formatCurrency(pricePerPack / cigarettesPerPack * cigarettesPerDay)}
                </p>

                {quitReasons.length > 0 && (
                  <div style={{ marginTop: '1rem' }}>
                    <strong>L√Ω do cai thu·ªëc c·ªßa t√¥i:</strong>
                    <ul style={{ margin: '0.5rem 0', paddingLeft: '1.5rem' }}>
                      {quitReasons.map((reason, index) => (
                        <li key={index}>{reason}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {quitStages.length > 0 && (
                  <div style={{ marginTop: '1rem' }}>
                    <strong>C√°c giai ƒëo·∫°n cai thu·ªëc c·ªßa t√¥i:</strong>
                    <div style={{
                      margin: '0.5rem 0',
                      maxHeight: '200px',
                      overflowY: 'auto',
                      background: '#f9f9f9',
                      borderRadius: '8px',
                      padding: '0.5rem'
                    }}>
                      {quitStages.map((stage, index) => (
                        <div key={index} style={{
                          marginBottom: index < quitStages.length - 1 ? '0.8rem' : 0,
                          paddingBottom: index < quitStages.length - 1 ? '0.8rem' : 0,
                          borderBottom: index < quitStages.length - 1 ? '1px solid #eee' : 'none'
                        }}>
                          <strong style={{ color: '#3498db' }}>{stage.name}</strong>
                          <div style={{ fontSize: '0.9rem', color: '#7f8c8d' }}>
                            {new Date(stage.startDate).toLocaleDateString('en-US')} ƒë·∫øn {new Date(stage.endDate).toLocaleDateString('en-US')}
                          </div>
                          <div style={{ margin: '0.3rem 0' }}>{stage.goal}</div>
                          <ul style={{ margin: '0.3rem 0', paddingLeft: '1.5rem' }}>
                            {stage.tasks.map((task, taskIndex) => (
                              <li key={taskIndex} style={{ fontSize: '0.9rem' }}>{task}</li>
                            ))}
                          </ul>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <button
                  onClick={resetPlan}
                  style={{
                    padding: '0.7rem 1.2rem',
                    backgroundColor: '#f39c12',
                    color: 'white',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: '500',
                    boxShadow: '0 2px 4px rgba(243, 156, 18, 0.3)',
                    marginTop: '1rem'
                  }}
                >
                  T·∫°o K·∫ø Ho·∫°ch M·ªõi
                </button>
              </div>
            )}
          </div>

          <div style={{
            padding: '2rem',
            backgroundColor: 'white',
            borderRadius: '15px',
            boxShadow: '0 5px 15px rgba(0, 0, 0, 0.05)'
          }}>
            <h2 style={{ fontWeight: '600', marginBottom: '1rem', color: '#35a79c' }}>Progress</h2>
            <p style={{ color: '#7f8c8d', lineHeight: '1.6', marginBottom: '1rem' }}>
              Smoke-free days: <span style={{ fontWeight: 'bold', color: '#e74c3c' }}>{smokeFreeCount}</span> days<br />
              Money saved: <span style={{ fontWeight: 'bold', color: '#27ae60' }}>{formatCurrency(moneySaved)}</span>
            </p>
            <div style={{ display: 'flex', gap: '1rem', flexWrap: 'wrap' }}>
              <button
                onClick={increaseSmokeFreeDay}
                style={{
                  padding: '0.7rem 1.2rem',
                  backgroundColor: '#3498db',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '500',
                  boxShadow: '0 2px 4px rgba(52, 152, 219, 0.3)'
                }}
              >
                Add Smoke-Free Day
              </button>
              <button
                onClick={resetSmokeFreeCount}
                style={{
                  padding: '0.7rem 1.2rem',
                  backgroundColor: '#e74c3c',
                  color: 'white',
                  border: 'none',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontWeight: '500',
                  boxShadow: '0 2px 4px rgba(231, 76, 60, 0.3)'
                }}
              >
                Reset
              </button>
            </div>
          </div>

          <div style={{
            padding: '2rem',
            backgroundColor: 'white',
            borderRadius: '15px',
            boxShadow: '0 5px 15px rgba(0, 0, 0, 0.05)'
          }}>
            <h2 style={{ fontWeight: '600', marginBottom: '1rem', color: '#35a79c' }}>Achievements</h2>
            {smokeFreeCount >= 1 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>üèÖ 1 day smoke-free</p>}
            {smokeFreeCount >= 7 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>üèÖ 7 days smoke-free</p>}
            {smokeFreeCount >= 30 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>üèÖ 30 days smoke-free</p>}
            {smokeFreeCount >= 90 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>üèÖ 90 days smoke-free</p>}
            {smokeFreeCount >= 180 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>üèÖ 180 days smoke-free</p>}
            {smokeFreeCount >= 365 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>üèÖ 1 year smoke-free!</p>}
            {smokeFreeCount === 0 && <p style={{ color: '#7f8c8d', lineHeight: '1.6' }}>You have no achievements yet. Start your quit journey!</p>}
          </div>
        </div>
      </div>
    </div>
  );
};

// ‚úÖ QUAN TR·ªåNG:
export default DashboardMember;
